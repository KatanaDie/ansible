#Это bash скрипт, создаём в любой директории на которую есть права файл коммандой touch %scriptname%.sh и вписываем вот это, всё работает без рут прав

#Путь до списка с хостами и паролями сделан атрибутом! Указываем его в конце строки с командой запуска скрипта

#Создание необходимых файлов и папок
hostspath=$1
mkdir /home/$USER/ansible
mkdir /home/$USER/ansible/playbooks
mkdir /home/$USER/mikrotik_backup

#Заполнение инвентарного файла, прописываются необходимые модули и логин от микротиков
cat <<EOF > /home/$USER/ansible/hosts
[mikrotik]

[mikrotik:vars]
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
ansible_user= user
ansible_network_os=community.routeros.routeros
EOF

#Запись в playbook кода создания и скачивания бэкапа на микротике, бэкап будет создан с названием "%имя хоста% %версия роутерос% %дата создания в виде год-месяц-день% SN %серийный номер устройства%.backup
cat <<EOF  > /home/$USER/ansible/playbooks/backup.yml
- hosts: mikrotik
  connection: network_cli
  gather_facts: false
  tasks:
  - name: collect facts
    community.routeros.facts:
     gather_subset: all
  - name: create backup
    routeros_command:
     commands: /system backup save name= "{{ansible_host}} {{ansible_net_version}} {{ lookup('pipe', 'date +%Y-%m-%d') }} SN {{ ansible_net_serialnum }}"
  - name: backup-file download
    ansible.netcommon.net_get:
        src: "{{ansible_host}} {{ansible_net_version}} {{ lookup('pipe', 'date +%Y-%m-%d') }} SN {{ ansible_net_serialnum }}.backup"
        dest: /home/$USER/mikrotik_backup/{{ansible_host}} {{ansible_net_version}} {{ lookup('pipe', 'date +%Y-%m-%d') }}.backup
        protocol: sftp
EOF

#Запись в playbook кода для подгрузки логинов и паролей в инвентарный файл из нашего текстового файла с хостами и паролями
cat <<EOF > /home/$USER/ansible/playbooks/hostlist.yml
- name: host:pass
  hosts: localhost
  tasks:
    - name: read
      command: cat $hostspath
      register: hosts_and_passwords
    - name: write
      ini_file:
        path: /home/$USER/ansible/hosts
        section: mikrotik
        option: "{{ item.split()[0] }}"
        value: "ansible_password={{ item.split()[1] }} ansible_port={{ item.split()[2] }}"
      loop: "{{ hosts_and_passwords.stdout_lines }}"
EOF

ansible-playbook /home/$USER/ansible/playbooks/hostlist.yml -i /home/$USER/ansible/hosts  #Запуск playbook заполняющего hosts из нашего текстового файла со списком хостов и паролей
ansible-playbook /home/$USER/ansible/playbooks/backup.yml -i /home/$USER/ansible/hosts #Запуск playbook который создаёт бэкап на тике и скачивает его
